name: CI

on:
  push:
    branches:
      - main
      - develop
      - "feature/**"
      - "bugfix/**"
      - "hotfix/**"
      - "release/**"
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read
  checks: write        # required by dorny/test-reporter to post check annotations
  pull-requests: write # required by dorny/test-reporter to comment on PRs

jobs:
  test:
    name: Test (Go ${{ matrix.go }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        go: ["1.22", "1.23", "stable"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}
          cache: false

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest

      # -short skips S3 network tests; -race catches data races.
      - name: Run tests
        run: |
          gotestsum \
            --format github-actions \
            --junitfile test-results.xml \
            --jsonfile test-output.json \
            -- -short -race -count=1 ./...

      - name: Compute coverage
        if: matrix.go == 'stable'
        run: |
          go test -short -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out | tee coverage.txt
          # Extract total coverage percentage
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
          echo "COVERAGE=${COVERAGE}" >> "$GITHUB_ENV"

      - name: Write step summary
        if: always()
        run: |
          echo "## Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          gotestsum --raw-command -- cat test-output.json 2>/dev/null || true
          # Extract pass/fail/skip counts from JUnit XML
          PASS=$(grep -c 'classname=' test-results.xml 2>/dev/null || echo 0)
          FAIL=$(grep -c '<failure' test-results.xml 2>/dev/null || echo 0)
          SKIP=$(grep -c 'skipped' test-results.xml 2>/dev/null || echo 0)
          echo "| Result | Count |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| ✅ Pass | ${PASS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| ❌ Fail | ${FAIL} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| ⏭ Skip | ${SKIP} |" >> "$GITHUB_STEP_SUMMARY"
          if [ -n "${COVERAGE}" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Coverage:** ${COVERAGE}" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-go${{ matrix.go }}
          path: |
            test-results.xml
            test-output.json
            coverage.out
            coverage.txt
          retention-days: 30

      - name: Annotate PR with test results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: "Go ${{ matrix.go }} Tests"
          path: test-results.xml
          reporter: java-junit
          fail-on-error: true

  vet:
    name: Vet & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true
      - name: go vet
        run: go vet ./...
      - name: gofmt
        run: |
          UNFORMATTED=$(gofmt -l .)
          if [ -n "$UNFORMATTED" ]; then
            echo "The following files need gofmt:"
            echo "$UNFORMATTED"
            exit 1
          fi
